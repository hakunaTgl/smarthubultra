name: LLM-Powered Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  copilot-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Review with Copilot
        uses: github/copilot-code-review-action@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  code-smell-detection:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Detect code smells with custom rules
        run: |
          echo "Running custom code smell detection..."
          npx eslint . --format json --output-file eslint-report.json || true
          node .github/scripts/analyze-smells.js
        continue-on-error: true
      
      - name: Comment on PR with findings
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('eslint-report.json')) {
              const report = JSON.parse(fs.readFileSync('eslint-report.json', 'utf8'));
              const issues = report.flatMap(f => f.messages);
              if (issues.length > 0) {
                const body = `## Code Quality Analysis\n\n` +
                  `Found **${issues.length}** issues:\n\n` +
                  issues.slice(0, 10).map(i => ` - ${i.rule}: ${i.message}`).join('\n');
                github.rest.issues.createComment({issue_number: context.issue.number, owner: context.repo.owner, repo: context.repo.repo, body});
              }
            }

  dependency-check:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check dependencies for vulnerabilities
        uses: dependabot/dependabot-action@main
        with:
          package-manager: npm
          directory: ./
        continue-on-error: true
